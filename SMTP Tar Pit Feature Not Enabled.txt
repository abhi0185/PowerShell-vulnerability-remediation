# Problem : Microsoft Windows Server 2003 SMTP Tar Pit Feature Not Enabled
# Jira Tracking ID : VRG-121
# Author : Abhishek Yadav
# Reviewer : B.Ugesh, Akash Agrawal
# Unit Test : Akshay Raut
# Date of Fix : 08/10/2017
# Objective : The script enables the Tar Pit Feature
# PowerShell script for Window OS
# preconditions : Admin access needed,Run Powershell as adminstrator, Please ensure BackUp before executing the code

# {

$ErrorActionPreference="SilentlyContinue"
Stop-Transcript | out-null
$ErrorActionPreference = "Continue"

$parentPath = split-path -parent $MyInvocation.MyCommand.Path
New-Item -path $parentPath\Log -ItemType directory -force
Start-Transcript -path $parentPath\Log\VRG7_VulnerabilityFix.log –append


$registryPath = "HKLM:\SYSTEM\CurrentControlSet\Services\SMTPSVC\Parameters"
$name = "TarpitTime"

$input = Read-Host -Prompt 'Do you want to use default value for Tarpit time interval? [y/n]'
if($input -eq "y"){
$value = "5"

# }
else {
$value = Read-Host -Prompt 'Provide time interval'
}


# setting tarpit time intervals       
write-host "setting tarpit time intervals    "

New-ItemProperty -Path $registryPath -Name $name -Value $value -PropertyType DWORD -Force


# restart smtp service
write-host "restart smtp service"



$SMTP=[adsi]"IIS://localhost/SMTPSVC/1"
$SMTP.ServerState = 4
$SMTP.SetInfo()
$SMTP=[adsi]"IIS://localhost/SMTPSVC/1"
$SMTP.ServerState = 2
$SMTP.SetInfo()

Stop-Transcript

}